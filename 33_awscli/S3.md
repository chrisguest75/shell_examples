# S3

Demonstrate how to use the `awscli` with S3  

NOTES:

* S3 is a global resource  

## Configure

```sh
export AWS_PROFILE=
export AWS_REGION=
```

## Create

```sh
aws s3 mb s3://chris-test-bucket-444
```

## Listing

```sh
# list buckets in the account
aws s3 ls
aws s3api list-buckets | jq '.["Buckets"][].Name' --raw-output 

# get tags 
aws s3api list-buckets | jq '.["Buckets"][].Name' --raw-output | while read in; do aws s3api get-bucket-tagging --bucket $in; done
```

```sh
# list contents of bucket 
aws --profile myprofile ls s3://bucket_name
```

## Copying

```sh
# Copy files from s3 into s3 subfolder
aws s3 cp "s3://file.json" "s3://bucket_name/folder/subfolder/ignition_etcd_0.json"

# copy local file to s3
aws --profile myprofile s3 cp ./fragment.json s3://bucket_name/fragment.json

# copying folders 
aws --profile myprofile s3 cp --recursive "s3://bucket/folder" ./folder

# copying folders and enabling public read access
aws --profile myprofile s3 cp --recursive "s3://bucket/folder" ./folder --acl public-read
```

## CORS

```sh
# examine the cors profile for the bucket
aws --profile myprofile s3api get-bucket-cors --bucket "bucket" | jq .
```

## Syncing

Syncing files can be done bi-directionally.

```sh
aws s3 sync s3://bucket_name path/to/target

# copy to public bucket and make available. 
AWS_PROFILE=myprofile aws s3 sync --acl public-read ./myfolder s3://mybucket/myfolder
```

## Presigning

```sh
# copy a file to a bucket
aws s3 cp ../BATCH.md s3://chris-test-bucket-444  

# expiry is in seconds
SIGNEDURL1=$(aws s3 presign chris-test-bucket-444/BATCH.md --expires-in 1000)
echo $SIGNEDURL1
SIGNEDURL2=$(aws s3 presign chris-test-bucket-444/BATCH.md --expires-in 1000)
echo $SIGNEDURL2
curl -v -s -o /dev/null $SIGNEDURL1
curl -v -s -o /dev/null $SIGNEDURL2
```

## Deleting

```sh
aws s3 rm s3://test-bucket/folder --recursive
```

## Resources

* What is Amazon S3? [here](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html)

